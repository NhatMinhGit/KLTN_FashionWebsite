<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>My Orders</title>
  <link th:href="@{/css/bootstrap-5.3.3.css}" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/fontawesome-6.7.1/css/all.css}">
  <script th:src="@{/js/bootstrap-5.3.3.js}"></script>
  <style>
    .product-img { width: 60px; height: 60px; object-fit: cover; }
    .status-paying { color: orange; font-weight: 500; }
    .status-pending { color: #ffc107; font-weight: 500; }
    .status-paid { color: #0d6efd; font-weight: 500; }
    .status-shipped { color: #6610f2; font-weight: 500; }
    .status-completed { color: #198754; font-weight: 600; }
    .status-cancelled { color: #dc3545; font-weight: 500; }
    .star-rating {
      display: flex;
      direction: rtl;
      justify-content: flex-start;
    }
    .star-rating input {
      display: none;
    }
    .star-rating label {
      font-size: 1.5rem;
      color: #ddd;
      cursor: pointer;
      margin: 0 2px;
    }
    .star-rating input:checked ~ label,
    .star-rating label:hover,
    .star-rating label:hover ~ label {
      color: #ffc107;
    }
    .text-muted {
      font-style: italic;
    }
  </style>
</head>
<body>
<div th:replace="~{fragments/header :: header}"></div>

<div class="container mt-4">
  <div class="row">
    <div class="col-md-3">
      <div th:replace="~{fragments/sidebar-profile :: sidebar}"></div>
    </div>
    <div class="col-md-9">
      <div class="container-order">
        <h2 class="mb-4">My Orders</h2>
        <div class="accordion" id="orderAccordion">
          <div class="accordion-item" th:each="order : ${orders}">
            <h2 class="accordion-header" th:id="'heading' + ${order.id}">
              <button class="accordion-button collapsed d-flex justify-content-between align-items-start"
                      type="button"
                      data-bs-toggle="collapse"
                      th:data-bs-target="'#collapse' + ${order.id}"
                      th:data-order-id="${order.id}"
                      th:data-status="${order.status.name()}"
                      th:aria-controls="'collapse' + ${order.id}"
                      aria-expanded="false">
                <span class="me-auto">
                  <strong th:text="'Order #' + ${order.id}"></strong><br>
                  <span th:class="'status-' + ${order.status.name().toLowerCase()}">
                    <th:block th:switch="${order.status}">
                      <i class="fa-solid fa-spinner" th:case="${T(org.example.fashion_web.backend.models.Order.OrderStatusType).PENDING}"></i>
                      <i class="fa-solid fa-clock" th:case="${T(org.example.fashion_web.backend.models.Order.OrderStatusType).PAYING}"></i>
                      <i class="fa-solid fa-credit-card" th:case="${T(org.example.fashion_web.backend.models.Order.OrderStatusType).PAID}"></i>
                      <i class="fa-solid fa-truck" th:case="${T(org.example.fashion_web.backend.models.Order.OrderStatusType).SHIPPED}"></i>
                      <i class="fa-solid fa-circle-check" th:case="${T(org.example.fashion_web.backend.models.Order.OrderStatusType).COMPLETED}"></i>
                      <i class="fa-solid fa-circle-xmark" th:case="${T(org.example.fashion_web.backend.models.Order.OrderStatusType).CANCELLED}"></i>
                    </th:block>
                    <span th:text="${order.status.name()}"></span>
                  </span>
                </span>
                <div class="ms-auto text-end">
                  <strong>Total:</strong>
                  <span th:text="${currencyFormatter.formatVND(order.totalPrice)}"></span>
                </div>
              </button>
            </h2>
            <div class="accordion-collapse collapse"
                 th:id="'collapse' + ${order.id}"
                 th:attr="aria-labelledby='heading' + ${order.id}"
                 data-bs-parent="#orderAccordion">
              <div class="accordion-body">
                <div class="mb-3">
                  <strong>Địa chỉ giao hàng:</strong><br>
                  <span th:text="${order.shippingAddress}">Địa chỉ mặc định</span>
                </div>
                <hr>
                <strong>Sản phẩm:</strong><br>
                <div class="order-items" th:id="'items-' + ${order.id}">Loading...</div>
                <div class="text-end mt-3">
                  <button class="btn btn-danger btn-sm cancel-order-btn"
                          th:id="'cancel-btn-' + ${order.id}"
                          th:data-order-id="${order.id}"
                          th:if="${order.status.name() == 'PENDING' or order.status.name() == 'PAYING'}">
                    Hủy đơn
                  </button>
                </div>
              </div>
            </div>
          </div> <!-- end each -->
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Review Modal -->
<div class="modal fade" id="reviewModal" tabindex="-1" aria-labelledby="reviewModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="reviewModalLabel">Đánh giá sản phẩm</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="reviewForm" method="post" class="mb-4 p-4 rounded shadow-sm bg-light">
          <div class="mb-3">
            <label class="form-label d-block mb-2 text-black">Đánh giá của bạn:</label>
            <div class="star-rating">
              <input type="radio" id="star5" name="rating" value="5" required><label for="star5">★</label>
              <input type="radio" id="star4" name="rating" value="4"><label for="star4">★</label>
              <input type="radio" id="star3" name="rating" value="3"><label for="star3">★</label>
              <input type="radio" id="star2" name="rating" value="2"><label for="star2">★</label>
              <input type="radio" id="star1" name="rating" value="1"><label for="star1">★</label>
            </div>
          </div>
          <div class="mb-3 text-black">
            <label for="commentContent" class="form-label">Bình luận của bạn:</label>
            <textarea class="form-control" id="commentContent" name="comment" rows="3" placeholder="Nhập bình luận..." required></textarea>
          </div>
          <button type="submit" class="btn btn-success">Gửi bình luận</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const accordion = document.getElementById('orderAccordion');

    accordion.addEventListener('show.bs.collapse', function (event) {
      const button = event.target.previousElementSibling.querySelector('button');
      const orderId = button.getAttribute('data-order-id');
      const itemsContainer = document.getElementById('items-' + orderId);
      const status = button.getAttribute('data-status');

      if (itemsContainer.dataset.loaded === 'true') return;

      fetch('/user/user-order/' + orderId + '/items')
              .then(response => response.json())
              .then(data => {
                let html = '';
                data.forEach(item => {
                  const productId = item.productId || 'unknown';
                  html += `
                <div class="d-flex align-items-center mb-3">
                    <img src="${item.productImageUrl}" class="product-img me-3" alt="Product">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">${item.productName}</h6>
                        <small>Quantity: ${item.quantity}</small><br>
                        <small>Price: ${item.pricePerUnit}</small>
                    </div>
                    ${
                          status === 'COMPLETED' && productId !== 'unknown' ?
                                  (item.hasReviewed ?
                                                  `<span class="text-muted">Đã đánh giá</span>` :
                                                  `<button class="btn btn-outline-primary btn-sm review-btn" data-bs-toggle="modal" data-bs-target="#reviewModal" data-product-id="${productId}">Review</button>`
                                  ) : ''
                  }
                </div>`;
                });
                itemsContainer.innerHTML = html;
                itemsContainer.dataset.loaded = 'true';
              })
              .catch(err => {
                console.error('Error loading items:', err);
                itemsContainer.innerHTML = `<p class="text-danger">Lỗi tải sản phẩm: ${err.message}</p>`;
              });
    });

    document.addEventListener('click', function (e) {
      if (e.target.classList.contains('cancel-order-btn')) {
        const orderId = e.target.getAttribute('data-order-id');
        if (!confirm("Bạn có chắc chắn muốn hủy đơn hàng #" + orderId + " không?")) return;

        fetch(`/user/user-order/${orderId}/cancel`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        })
                .then(res => {
                  if (res.ok) {
                    alert("Đã hủy đơn hàng thành công!");
                    location.reload();
                  } else {
                    return res.text().then(msg => { throw new Error(msg); });
                  }
                })
                .catch(err => {
                  alert("Lỗi khi hủy đơn hàng: " + err.message);
                });
      }
    });

    // Handle Review button click
    document.addEventListener('click', function (e) {
      if (e.target.classList.contains('review-btn')) {
        const productId = e.target.getAttribute('data-product-id');
        const form = document.getElementById('reviewForm');
        // Ghi log để kiểm tra
        console.log('Product ID:', productId);
        if (productId && productId !== 'undefined') {
          form.action = `/user/product-detail/${productId}/comments`;
        } else {
          console.error('Product ID is undefined or invalid');
          // Có thể hiển thị thông báo lỗi cho người dùng
          alert('Không thể mở form đánh giá: ID sản phẩm không hợp lệ.');
        }
      }
    });
  });
</script>
</body>
</html>