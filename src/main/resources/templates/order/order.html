<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8">
  <title>Thanh to√°n</title>
  <link th:href="@{/css/bootstrap-5.3.3.css}" rel="stylesheet">
  <link rel="stylesheet" th:href="@{/fontawesome-6.7.1/css/all.css}">
  <script th:src="@{/js/bootstrap-5.3.3.js}"></script>
  <style>
    body {
        background-color: #f8f9fa;
    }

    .container {
        max-width: 900px;
    }

    .order-summary,
    .order-details,
    .payment-method,
    .order-voucher {
        background-color: #fff;
        padding: 20px;
        border-radius: 8px;
        margin-top: 20px;
    }

    .order-summary h5,
    .order-details h5,
    .payment-method h5,
    .order-voucher h5 {
        font-weight: bold;
    }

    .btn-continue {
        background-color: #ff5722;
        color: white;
        font-weight: bold;
    }

    .btn-continue:hover {
        background-color: #e64a19;
    }

    .order-card img {
        width: 60px;
        height: 60px;
        object-fit: cover;
    }

    .order-card {
        display: flex;
        align-items: center;
        padding: 10px;
        border-bottom: 1px solid #ddd;
    }

    .order-info {
        flex-grow: 1;
        margin-left: 10px;
    }

    .quantity-control {
        display: flex;
        align-items: center;
    }

    .quantity-control button {
        border: 1px solid #ddd;
        background: none;
        padding: 5px 10px;
    }
  </style>
</head>

<body>
<!-- Import Header -->
<div th:replace="~{fragments/header :: header}"></div>
<div class="container py-4">
  <div class="row">
    <!-- Shipping Address -->
    <div class="col-md-7">
      <div class="card p-4">
        <h5>Th√¥ng tin giao h√†ng</h5>
        <p class="text-danger" style="font-size: 12px; font-style: italic;">
          (D·ªØ li·ªáu n√†y s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u l·∫°i khi ch∆∞a t·∫°o t√†i kho·∫£n ho·∫∑c kh√¥ng nh·∫•n c·∫≠p nh·∫≠t)
        </p>
        <form id="editProfileForm" method="post" th:object="${userProfileDto}"
              th:action="@{/user/order/save-user}" enctype="multipart/form-data">
          <input type="hidden" th:field="*{id}" id="userId">
          <div class="mb-3">
            <label for="name" class="form-label">H·ªç v√† t√™n <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="name" th:field="*{user.name}" required>
          </div>
          <div class="mb-3">
            <label for="phoneNumber" class="form-label">S·ªë ƒëi·ªán tho·∫°i</label> <span
                  class="text-danger">*</span>
            <input type="text" class="form-control" id="phoneNumber" th:field="*{phoneNumber}" required>
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">Email <span class="text-danger">*</span></label>
            <input type="email" class="form-control" id="email" th:field="*{user.email}" readonly
                   disabled>
          </div>

          <div class="mb-3">
            <label for="city" class="form-label">Th√†nh ph·ªë</label>
            <select class="form-control" id="city" name="cityId">
              <option value="">-- Ch·ªçn Th√†nh ph·ªë --</option>
              <option th:each="c : ${cities}" th:value="${c.id}" th:text="${c.cityName}"
                      th:selected="${userProfileDto.ward?.district?.city?.id == c.id}"></option>
            </select>
            <input type="hidden" id="selectedCity" name="cityIdd">
          </div>

          <div class="mb-3">
            <label for="district" class="form-label">Qu·∫≠n/Huy·ªán</label>
            <select class="form-control" id="district" name="districtId">
              <option value="">-- Ch·ªçn Qu·∫≠n/Huy·ªán --</option>
            </select>
            <input type="hidden" id="selectedDistrict" name="districtIdd">
          </div>

          <div class="mb-3">
            <label for="ward" class="form-label">Ph∆∞·ªùng/X√£</label>
            <select class="form-control" id="ward" name="wardId">
              <option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>
            </select>
            <input type="hidden" id="selectedWard" name="wardIdd">
            <span class="text-danger" id="wardError"></span>
            <input type="hidden" id="detailAddress" th:value="${detailaddress}">
          </div>

          <div class="mb-3">
            <label for="address" class="form-label">T√≤a nh√†, s·ªë nh√†, t√™n ƒë∆∞·ªùng</label>
            <input type="text" class="form-control" id="address" th:field="*{address}">
          </div>
          <div class="d-flex justify-content-between">
            <button type="submit" class="btn btn-primary align-end" id="btnUpdate">C·∫≠p nh·∫≠t</button>
          </div>
        </form>
      </div>


      <!-- Payment Method -->
      <div class="payment-method mt-4">
        <h5>Ph∆∞∆°ng th·ª©c thanh to√°n</h5>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="paymentMethod" id="CASH" value="CASH" checked>
          <label class="form-check-label" for="CASH">Thanh to√°n khi nh·∫≠n h√†ng</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="paymentMethod" id="CREDIT_CARD" value="CREDIT_CARD">
          <label class="form-check-label" for="CREDIT_CARD">Credit Card</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="paymentMethod" id="BANK_TRANSFER" value="BANK_TRANSFER">
          <label class="form-check-label" for="BANK_TRANSFER">Chuy·ªÉn kho·∫£n ng√¢n h√†ng</label>
        </div>
      </div>
    </div>

    <!-- Order Summary -->
    <div class="col-md-5">
      <!-- Order Details -->
      <div class="order-details mt-4">
        <h5>Chi ti·∫øt ƒë∆°n h√†ng</h5>
        <div th:each="item : ${cartItems}" class="order-card">
          <img th:src="@{${productImages}}" class="img-fluid rounded-3" th:alt="${item.product.name}">
          <div class="order-info">
            <p class="mb-0" th:text="${item.product.name}"></p>
            <small class="text-muted" th:text="${item.product.category.name}"></small>
            <div class="quantity-control mt-1">
              <!--              <button>-</button>-->
              <!--              <span class="mx-2">2</span>-->
              <!--              <button>+</button>-->
              <span class="mx-2">Quantity: <span th:text="${item.quantity}"></span></span>
            </div>
          </div>
          <strong th:text="${item.pricePerUnit}"></strong>
        </div>
      </div>
      <!-- Modal hi·ªÉn th·ªã danh s√°ch voucher -->
      <div class="modal fade" id="voucherModal" tabindex="-1" aria-labelledby="voucherModalLabel"
           aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="voucherModalLabel">Danh s√°ch Voucher</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"
                      aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table table-striped">
                <thead>
                <tr>
                  <th>M√£</th>
                  <th>T√™n</th>
                  <th>H·∫°n s·ª≠ d·ª•ng</th>
                  <th>Ch·ªçn</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="voucher : ${vouchers}">
                  <td th:text="${voucher.voucherCode}"></td>
                  <td th:text="${voucher.voucherName}"></td>
                  <td th:text="${#temporals.format(voucher.endDate, 'dd/MM/yyyy')}"></td>
                  <td>
                    <button class="btn btn-primary btn-sm apply-voucher"
                            th:data-code="${voucher.voucherCode}"
                            th:data-name="${voucher.voucherName}">
                      Ch·ªçn
                    </button>
                  </td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="order-voucher">
        <h5>Voucher v√† Coupon</h5>
        <a href="#" class="text-muted float-end" data-bs-toggle="modal" data-bs-target="#voucherModal">Xem
          t·∫•t c·∫£</a>
        <div class="input-group mt-2">
          <input type="text" class="form-control" placeholder="Nh·∫≠p m√£ gi·∫£m gi√° (n·∫øu c√≥)"
                 aria-label="Voucher" id="selectedVoucher">

          <button class="btn btn-outline-secondary fw-bold" type="button" onclick="applyVoucher()">√Åp d·ª•ng</button>
        </div>
      </div>
      <div class="order-summary">
        <h5>ƒê∆°n h√†ng</h5>
        <table class="table table-borderless">
          <tbody>
          <tr>
            <td>T·ªïng ƒë∆°n h√†ng</td>
            <td>:</td>
            <td class="fw-bold" id="totalorderprice">[[${totalOrderPrice}]]</td>
          </tr>
          <tr>
            <td>Ph√≠ v·∫≠n chuy·ªÉn</td>
            <td>:</td>
            <td class="text-success">Free ship</td>
          </tr>

          <tr>
            <td>Gi·∫£m gi√°</td>
            <td>:</td>
            <td id="discount" class="text-danger">0</td>
          </tr>

          <tr class="border-top">
            <td>
              <h6>Th√†nh ti·ªÅn</h6>
            </td>
            <td>:</td>
            <td class="fw-bold" id="totalPrice">[[${totalOrderPrice}]]</td>
          </tr>
          </tbody>
        </table>
        <button class="btn btn-continue w-100" id="checkoutBtn">Thanh to√°n</button>
      </div>
    </div>
  </div>


</div>
</body>
<script>
  document.addEventListener("DOMContentLoaded", function () {
      console.log("DOM fully loaded and parsed");
        var citySelect = document.getElementById("city");
        var districtSelect = document.getElementById("district");
        var wardSelect = document.getElementById("ward");

        var editProfileForm = document.getElementById("editProfileForm");
        var updateButton = document.getElementById("btnUpdate");

        updateButton.addEventListener("click", function (event) {
            event.preventDefault(); // NgƒÉn form g·ª≠i ngay l·∫≠p t·ª©c

            // L·∫•y gi√° tr·ªã c√°c tr∆∞·ªùng input
            var name = document.getElementById("name").value.trim();
            var phoneNumber = document.getElementById("phoneNumber").value.trim();
            var address = document.getElementById("address").value.trim();
            var city = document.getElementById("city").value;
            var district = document.getElementById("district").value;
            var ward = document.getElementById("ward").value;

            // Ki·ªÉm tra tr∆∞·ªùng tr·ªëng
            if (!name) {
                alert("Vui l√≤ng nh·∫≠p h·ªç v√† t√™n!");
                return;
            }
            if (!phoneNumber || phoneNumber == "Ch∆∞a c·∫≠p nh·∫≠t!") {
                alert("Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i!");
                return;
            }
            if (!address || address == "Ch∆∞a c·∫≠p nh·∫≠t!") {
                alert("Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ!");
                return;
            }
            if (!city) {
                alert("Vui l√≤ng ch·ªçn Th√†nh ph·ªë!");
                return;
            }
            if (!district) {
                alert("Vui l√≤ng ch·ªçn Qu·∫≠n/Huy·ªán!");
                return;
            }
            if (!ward) {
                alert("Vui l√≤ng ch·ªçn Ph∆∞·ªùng/X√£!");
                return;
            }

            // Hi·ªÉn th·ªã x√°c nh·∫≠n tr∆∞·ªõc khi g·ª≠i form
            if (confirm("B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën c·∫≠p nh·∫≠t th√¥ng tin kh√¥ng?")) {
                editProfileForm.submit();
            }
        });

        // G√°n gi√° tr·ªã dropdown v√†o input hidden khi thay ƒë·ªïi
        citySelect.addEventListener("change", function () {
            document.getElementById("selectedCity").value = this.value;
            console.log("Selected City:", this.value);
        });

        districtSelect.addEventListener("change", function () {
            document.getElementById("selectedDistrict").value = this.value;
            console.log("Selected District:", this.value);
        });

        wardSelect.addEventListener("change", function () {
            document.getElementById("selectedWard").value = this.value;
            console.log("Selected Ward:", this.value);
        });

        // L·∫•y d·ªØ li·ªáu t·ª´ Thymeleaf
        var selectedCityId = citySelect.value;
        var selectedDistrictId = `[[${userProfileDto.ward?.district?.id ?: ''}]]`.trim();
        var selectedWardId = `[[${userProfileDto.ward?.id ?: ''}]]`.trim();

        selectedDistrictId = selectedDistrictId ? selectedDistrictId : null;
        selectedWardId = selectedWardId ? selectedWardId : null;

        function loadDistricts(selectedDistrictId, callback) {
            var cityId = citySelect.value;
            districtSelect.innerHTML = '<option value="">-- Ch·ªçn Qu·∫≠n/Huy·ªán --</option>';
            wardSelect.innerHTML = '<option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>';
            wardSelect.disabled = true;

            if (!cityId) {
                districtSelect.disabled = true;
                return;
            }

            fetch(`/districts?cityId=${cityId}`)
                .then(response => response.json())
                .then(data => {
                    console.log("Districts loaded: ", data);
                    data.forEach(district => {
                        let option = new Option(district.districtName, district.id);
                        districtSelect.add(option);
                        if (selectedDistrictId && district.id == selectedDistrictId) {
                            option.selected = true;
                        }
                    });
                    districtSelect.disabled = false;
                    if (callback) callback();
                })
                .catch(error => console.error("L·ªói khi t·∫£i Qu·∫≠n/Huy·ªán:", error));
        }

        function loadWards(selectedDistrictId, selectedWardId) {
            var districtId = selectedDistrictId || districtSelect.value;
            wardSelect.innerHTML = '<option value="">-- Ch·ªçn Ph∆∞·ªùng/X√£ --</option>';

            if (!districtId) {
                wardSelect.disabled = true;
                return;
            }

            fetch(`/wards?districtId=${districtId}`)
                .then(response => response.json())
                .then(data => {
                    console.log("Wards loaded: ", data);
                    data.forEach(ward => {
                        let option = new Option(ward.wardName, ward.id);
                        wardSelect.add(option);
                        if (selectedWardId && ward.id == selectedWardId) {
                            option.selected = true;
                        }
                    });
                    wardSelect.disabled = false;
                })
                .catch(error => console.error("L·ªói khi t·∫£i Ph∆∞·ªùng/X√£:", error));
        }

        // Load districts khi city thay ƒë·ªïi
        citySelect.addEventListener("change", function () {
            loadDistricts(null, null);
        });

        // Load wards khi district thay ƒë·ªïi
        districtSelect.addEventListener("change", function () {
            loadWards(null, null);
        });

        // Load d·ªØ li·ªáu khi trang v·ª´a t·∫£i
        if (selectedCityId) {
            loadDistricts(selectedDistrictId, function () {
                if (selectedDistrictId) {
                    loadWards(selectedDistrictId, selectedWardId);
                }
            });
        }

      // √°p m√£ voucher
      let voucherModal = document.getElementById("voucherModal");

      voucherModal.addEventListener("shown.bs.modal", function () {
          document.querySelectorAll(".apply-voucher").forEach(button => {
              button.addEventListener("click", function () {
                  let voucherCode = this.getAttribute("data-code");
                  let voucherName = this.getAttribute("data-name");

                  // ƒêi·ªÅn m√£ voucher v√†o √¥ nh·∫≠p
                  document.getElementById("selectedVoucher").value = voucherCode;

                  // Hi·ªÉn th·ªã th√¥ng b√°o
                  alert(`B·∫°n ƒë√£ ch·ªçn voucher ${voucherName} - C√≥ m√£: ${voucherCode}`);

                  // ƒê√≥ng modal
                  let modalInstance = bootstrap.Modal.getInstance(voucherModal);
                  modalInstance.hide();
              });
          });
      });

      document.getElementById("checkoutBtn").addEventListener("click", function(event) {
        event.preventDefault();
        savePaymentInfo();

        if (!confirm("B·∫°n ch·∫Øc ch·∫Øn mu·ªën ƒë·∫∑t h√†ng ch·ª© ?")) {
            return;
        }

        // T·∫°o m·ªôt form ·∫©n v√† g·ª≠i POST request
        let form = document.createElement("form");
        form.method = "POST";
        form.action = "/user/order/checkout";

        document.body.appendChild(form);
        form.submit();

    });
  });

  // c·∫≠p nh·∫≠t gi√° khi √°p voucher
  function applyVoucher() {
      let voucherCode = document.getElementById("selectedVoucher").value;

      if (!voucherCode) {
        document.getElementById("totalPrice").innerHTML = document.getElementById("totalorderprice").innerHTML;
        document.getElementById("discount").innerHTML = 0;
      }

      fetch("/apply-order-voucher?voucherCode=" + voucherCode, {
          method: "POST"
      })
          .then(response => response.json())
          .then(data => {
              if (data.success) {
                  document.getElementById("totalPrice").innerHTML = data.newTotal;
                  document.getElementById("discount").innerHTML = "- " + data.discountAmount;
              } else {
                  alert("M√£ gi·∫£m gi√° kh√¥ng h·ª£p l·ªá!");
              }
          })
          .catch(error => console.error("L·ªói:", error));
  }
  ////
  function savePaymentInfo() {
      let addresss = document.getElementById("detailAddress").value || "Ch∆∞a c√≥ ƒë·ªãa ch·ªâ";
      let paymentData = {
          userId: document.getElementById("userId").value,
          paymentMethod: document.querySelector('input[name="paymentMethod"]:checked').value,
          shippingAddress: addresss,
          totalPrice: document.getElementById("totalPrice").innerHTML,
          voucherCode: document.getElementById("selectedVoucher").value
      };
      console.log("üîπ D·ªØ li·ªáu thanh to√°n s·∫Ω ƒë∆∞·ª£c g·ª≠i:", paymentData); // In d·ªØ li·ªáu ra console
      fetch('/payment/save-info', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify(paymentData)
      })
      .catch(error => console.error("L·ªói:", error));
  }

</script>

</html>