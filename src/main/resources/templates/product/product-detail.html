<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Chi tiết sản phẩm</title>
    <link th:href="@{/css/bootstrap-5.3.3.css}" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/fontawesome-6.7.1/css/all.css}">
    <script th:src="@{/js/bootstrap-5.3.3.js}"></script>
    <link th:href="@{/css/product-detail.css}" rel="stylesheet">
    <script th:src="@{/js/guide-modal.js}"></script>
</head>
<body>

<!-- Header -->
<div th:replace="~{fragments/header :: header}"></div>

<div class="container mt-5">
    <div class="row">
        <!-- Product Images -->
        <div class="col-md-6 mb-4">
            <div th:if="${imagesByColor != null and imagesByColor.containsKey(selectedColor) and not #lists.isEmpty(imagesByColor.get(selectedColor))}">
                <img th:src="@{${imagesByColor.get(selectedColor)[0]}}"
                     id="mainImage"
                     class="d-block w-100 product-img"
                     th:alt="${product.name}">
            </div>
            <div th:unless="${imagesByColor != null and imagesByColor.containsKey(selectedColor) and not #lists.isEmpty(imagesByColor.get(selectedColor))}">
                <p>Không có ảnh cho màu đã chọn.</p>
            </div>

            <div class="d-flex justify-content-between mt-2 carousel-item" id="thumbnailContainer">
                <img th:each="imageUri : ${imagesByColor.containsKey(selectedColor) ? imagesByColor.get(selectedColor) : T(java.util.Collections).emptyList()}"
                     th:src="@{${imageUri}}"
                     class="thumbnail"
                     th:alt="${product.name}"
                     onclick="changeImage(this)">
            </div>
        </div>

        <!-- Product Details -->
        <div class="col-md-6" id="product-details" th:data-id="${product.id}" th:data-variant-id="${variantIdByColor.get(selectedColor)}">
            <input type="hidden" id="productId" th:value="${product.id}">
            <h2 class="mb-3" th:text="${product.name}"></h2>
            <p class="text-white mb-4" th:text="${product.description}"></p>

            <div class="mb-3">
                <span id="price" th:text="${product.effectivePrice}" style="display: none;"></span>
                <span class="h4 me-2" th:text="${@currencyFormatter.formatVND(product.effectivePrice)}"></span>
            </div>

            <!-- Chọn màu -->
<!--            <div class="mb-4" >-->
<!--                <label for="colorSelect" class="form-label">Màu sắc:</label>-->
<!--                <select class="form-select" id="colorSelect" required>-->
<!--                    <option value="" selected disabled>Chọn màu</option>-->
<!--                    <option th:each="color : ${sizesByColor.keySet()}"-->
<!--                            th:value="${color}"-->
<!--                            th:text="${color}"-->
<!--                            th:selected="${color == selectedColor}">-->
<!--                    </option>-->
<!--                </select>-->
<!--                <input type="hidden" id="selectedColor" name="selectedColor" th:value="${selectedColor}">-->
<!--            </div>-->
            <div id="sizeContainer" class="mb-4">
                <label class="form-label">Chọn màu:</label>
                <div class="d-flex gap-3 flex-wrap">
                    <div th:each="entry : ${imagesByColor}" class="text-center">
                        <img th:src="${entry.value[0]}"
                        th:alt="${entry.key}"
                        th:data-color="${entry.key}"
                        class="color-thumbnail border"
                        style="width: 50px; height: 50px; cursor: pointer;"
                        onclick="selectColor(this)">
                        <div th:text="${entry.key}" style="font-size: 12px; margin-top: 4px;"></div> <!-- tên màu -->
                    </div>
                </div>
                <input type="hidden" id="selectedColor" name="selectedColor" th:value="${selectedColor}">
            </div>


            <!-- Chọn size -->
            <div class="mb-4">
                <div class="btn-group" role="group" aria-label="Chọn size">
                    <button type="button" class="btn btn-outline-dark " onclick="selectSize('S')">S</button>
                    <button type="button" class="btn btn-outline-dark " onclick="selectSize('M')">M</button>
                    <button type="button" class="btn btn-outline-dark " onclick="selectSize('L')">L</button>
                    <button type="button" class="btn btn-outline-dark " onclick="selectSize('XL')">XL</button>
                    <button type="button" class="btn btn-outline-dark " onclick="selectSize('XXL')">XXL</button>
                </div>
                <input type="hidden" name="selectedSize" id="selectedSize" required>
                <!-- Stock message will be displayed here -->
                <p id="stockMessage" class="text-danger" style="display: none;"></p>
            </div>
            <div class="mb-4">
                <button type="button" class="btn btn-link p-0 mt-2" data-bs-toggle="modal" data-bs-target="#sizeGuideModal">
                    <i class="fa-solid fa-ruler-combined"></i> Hướng dẫn chọn size
                </button>
                <div th:replace="fragments/size-guild-modal-fragment :: sizeGuideModal"></div>
                <div th:replace="fragments/measure-size-guild-fragment :: measureGuideModal"></div>

            </div>
            <!-- Số lượng -->
            <div class="mb-4">
                <label for="quantity" class="form-label fw-bold">Số lượng:</label>
                <div class="input-group" style="max-width: 160px;">
                    <button class="btn btn-outline-secondary" type="button" onclick="changeQuantity(-1)">-</button>
                    <input type="number" id="quantity" class="form-control text-center" value="1" min="1" required>
                    <button class="btn btn-outline-secondary" type="button" onclick="changeQuantity(1)">+</button>
                </div>
            </div>

            <button class="btn btn-primary btn-lg mb-3 me-2" onclick="addToCart()">
                <i class="fas fa-cart-plus"></i> Thêm vào giỏ
            </button>
            <button class="btn btn-outline-secondary btn-lg mb-3">
                <i class="fas fa-heart"></i> Yêu thích
            </button>
        </div>
    </div>
</div>

<!-- Bình luận -->
<div class="container mt-5">
    <h4 class="mb-4">Bình luận</h4>

    <form th:action="@{/user/product-detail/{id}/comments(id=${product.id})}" method="post"
          class="mb-4 p-4 rounded shadow-sm bg-light">
        <div class="mb-3">
            <label class="form-label d-block mb-2 text-black">Đánh giá của bạn:</label>
            <div class="star-rating">
                <input type="radio" id="star5" name="rating" value="5" required><label for="star5">★</label>
                <input type="radio" id="star4" name="rating" value="4"><label for="star4">★</label>
                <input type="radio" id="star3" name="rating" value="3"><label for="star3">★</label>
                <input type="radio" id="star2" name="rating" value="2"><label for="star2">★</label>
                <input type="radio" id="star1" name="rating" value="1"><label for="star1">★</label>
            </div>
        </div>

        <div class="mb-3 text-black">
            <label for="commentContent" class="form-label">Bình luận của bạn:</label>
            <textarea class="form-control" id="commentContent" name="comment" rows="3" placeholder="Nhập bình luận..." required></textarea>
        </div>

        <button type="submit" class="btn btn-success">Gửi bình luận</button>
    </form>

    <div th:if="${#lists.isEmpty(feedbacks)}">
        <p class="text-white fst-italic">Chưa có bình luận nào. Hãy là người đầu tiên!</p>
    </div>

    <div class="comment-container mb-4 p-3 rounded border bg-white shadow-sm" style="max-height: 300px; overflow-y: auto;">
        <div th:each="feedback : ${feedbacks}" class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0 fw-bold text-primary" th:text="${feedback.user.name}">Tên người dùng</h6>
                <small class="text-muted" th:text="${#dates.format(feedback.createdAt, 'dd/MM/yyyy HH:mm')}"></small>
            </div>
            <div class="mb-1">
                <span class="badge bg-warning text-dark">
                    ⭐ <span th:text="${feedback.rating}">5</span>/5
                </span>
            </div>
            <p class="mb-0 text-black" th:text="${feedback.comment}">Nội dung bình luận</p>
        </div>
    </div>
</div>

<!-- Footer -->
<div th:replace="~{fragments/footer :: footer}"></div>

<script th:src="@{/js/product-detail.js}"></script>

</body>
</html>
